name: Tag next release

on:
    workflow_call:

env:
    GITHUB_TOKEN: ${{ secrets.ACTION_ACCESS_TOKEN }}

jobs:
    semver:
        runs-on: ubuntu-latest
        if: github.event.pull_request.merged
        outputs:
            tag: ${{ steps.semver.outputs.tag }}
        steps:
            -   name: Tag
                id: semver
                uses: K-Phoen/semver-release-action@master
                with:
                    release_branch: main
                    release_strategy: none
                env:
                    GITHUB_TOKEN: ${{ secrets.ACTION_ACCESS_TOKEN }}
    composer_version:
        runs-on: ubuntu-latest
        needs: semver
        if: startsWith(github.event.repository.name, 'php-')
        steps:
            -   uses: actions/checkout@v2
                with:
                    ref: ${{ github.event.repository.default_branch }}
            -   name: Create tag
                run: |
                    tag=${{ needs.semver.outputs.tag }}
                    message='${{ needs.semver.outputs.tag }}: PR #${{ github.event.pull_request.number }} ${{ github.event.pull_request.title }}'
                    git config user.name "${GITHUB_ACTOR}"
                    git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
                    git tag -a "${tag}" -m "${message}"
            -   name: Push changes
                uses: ad-m/github-push-action@master
                with:
                    github_token: ${{ secrets.GITHUB_TOKEN }}
                    tags: true
    npm_version:
        runs-on: ubuntu-latest
        needs: semver
        if: startsWith(github.event.repository.name, 'ts-')
        steps:
            -   uses: actions/checkout@v2
                with:
                    ref: ${{ github.event.repository.default_branch }}
            -   name: 'change version'
                uses: reedyuk/npm-version@1.1.1
                with:
                    version: ${{ needs.semver.outputs.tag }}
                    git-tag-version: true
